<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Templates - Ori Agent</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/css/workspace.css">
    <style>
        body {
            background: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .workflows-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .page-header p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .template-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .template-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .template-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .template-category {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .template-category.research {
            background: #e3f2fd;
            color: #1976d2;
        }

        .template-category.analysis {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .template-category.validation {
            background: #e8f5e9;
            color: #388e3c;
        }

        .template-description {
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .template-roles {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .role-badge {
            padding: 4px 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .template-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 22px;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-help {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .required {
            color: #dc3545;
        }

        /* Execution Status */
        .execution-status {
            margin-top: 30px;
            padding: 20px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .execution-status.hidden {
            display: none;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .workspace-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
        }

        .workspace-link:hover {
            text-decoration: underline;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Dark mode specific */
        [data-theme="dark"] .template-category.research {
            background: #1565c0;
            color: #e3f2fd;
        }

        [data-theme="dark"] .template-category.analysis {
            background: #6a1b9a;
            color: #f3e5f5;
        }

        [data-theme="dark"] .template-category.validation {
            background: #2e7d32;
            color: #e8f5e9;
        }
    </style>
</head>
<body>
    <div class="workflows-container">
        <div class="page-header">
            <h1>Workflow Templates</h1>
            <p>Pre-built multi-agent workflows for research, analysis, and validation</p>
        </div>

        <div id="templates-loading" class="loading">
            <div class="spinner"></div>
            <p>Loading workflow templates...</p>
        </div>

        <div id="templates-grid" class="templates-grid" style="display: none;"></div>

        <div id="execution-status" class="execution-status hidden">
            <div class="status-header">
                <h3>Workflow Execution</h3>
                <a href="#" id="workspace-link" class="workspace-link" style="display: none;">View Workspace</a>
            </div>
            <div id="workflow-status-container"></div>
        </div>
    </div>

    <!-- Instantiate Template Modal -->
    <div id="instantiate-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Execute Workflow</h2>
                <button class="close-btn" onclick="closeInstantiateModal()">&times;</button>
            </div>
            <form id="instantiate-form">
                <input type="hidden" id="template-id" name="template_id">

                <div class="form-group">
                    <label for="agent-name">Agent Name <span class="required">*</span></label>
                    <select id="agent-name" name="agent_name" required>
                        <option value="">Select an agent...</option>
                    </select>
                    <div class="form-help">The agent that will coordinate this workflow</div>
                </div>

                <div id="parameters-container"></div>

                <div class="template-actions">
                    <button type="submit" class="btn btn-primary">Execute Workflow</button>
                    <button type="button" class="btn btn-secondary" onclick="closeInstantiateModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { workspaceManager } from '/js/modules/workspace.js';

        let templates = [];
        let agents = [];
        let currentTemplate = null;
        let currentWorkspaceId = null;

        // Load templates on page load
        async function loadTemplates() {
            try {
                const response = await fetch('/api/orchestration/templates');
                if (!response.ok) throw new Error('Failed to load templates');

                const data = await response.json();
                templates = data.templates || [];

                document.getElementById('templates-loading').style.display = 'none';
                document.getElementById('templates-grid').style.display = 'grid';

                renderTemplates();
            } catch (error) {
                console.error('Error loading templates:', error);
                document.getElementById('templates-loading').innerHTML =
                    '<p style="color: #dc3545;">Failed to load templates. Please refresh the page.</p>';
            }
        }

        // Load agents for dropdown
        async function loadAgents() {
            try {
                const response = await fetch('/api/agents');
                if (!response.ok) throw new Error('Failed to load agents');

                agents = await response.json();
            } catch (error) {
                console.error('Error loading agents:', error);
            }
        }

        // Render templates grid
        function renderTemplates() {
            const grid = document.getElementById('templates-grid');
            grid.innerHTML = '';

            templates.forEach(template => {
                const card = createTemplateCard(template);
                grid.appendChild(card);
            });
        }

        // Create template card element
        function createTemplateCard(template) {
            const card = document.createElement('div');
            card.className = 'template-card';

            const rolesHTML = template.required_roles.map(role =>
                `<span class="role-badge">${role}</span>`
            ).join('');

            card.innerHTML = `
                <div class="template-card-header">
                    <div class="template-name">${escapeHtml(template.name)}</div>
                    <span class="template-category ${template.category}">${template.category}</span>
                </div>
                <div class="template-description">${escapeHtml(template.description)}</div>
                <div class="template-roles">
                    ${rolesHTML}
                </div>
                <div class="template-actions">
                    <button class="btn btn-primary" onclick="window.openInstantiateModal('${template.id}')">
                        Execute
                    </button>
                    <button class="btn btn-secondary" onclick="window.viewTemplateDetails('${template.id}')">
                        Details
                    </button>
                </div>
            `;

            return card;
        }

        // Open instantiate modal
        window.openInstantiateModal = async function(templateId) {
            currentTemplate = templates.find(t => t.id === templateId);
            if (!currentTemplate) return;

            document.getElementById('template-id').value = templateId;

            // Load agents if not loaded
            if (agents.length === 0) {
                await loadAgents();
            }

            // Populate agent dropdown
            const agentSelect = document.getElementById('agent-name');
            agentSelect.innerHTML = '<option value="">Select an agent...</option>';
            agents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.name;
                option.textContent = agent.name;
                agentSelect.appendChild(option);
            });

            // Render parameter fields
            renderParameterFields(currentTemplate.parameters);

            // Show modal
            document.getElementById('instantiate-modal').classList.add('active');
        };

        // Close instantiate modal
        window.closeInstantiateModal = function() {
            document.getElementById('instantiate-modal').classList.remove('active');
            document.getElementById('instantiate-form').reset();
            currentTemplate = null;
        };

        // Render parameter input fields
        function renderParameterFields(parameters) {
            const container = document.getElementById('parameters-container');
            container.innerHTML = '';

            if (!parameters || parameters.length === 0) return;

            parameters.forEach(param => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                let inputHTML = '';
                const required = param.required ? 'required' : '';
                const requiredMark = param.required ? '<span class="required">*</span>' : '';

                if (param.type === 'boolean') {
                    inputHTML = `
                        <select id="param-${param.name}" name="param-${param.name}" ${required}>
                            <option value="true" ${param.default_value === true ? 'selected' : ''}>Yes</option>
                            <option value="false" ${param.default_value === false ? 'selected' : ''}>No</option>
                        </select>
                    `;
                } else if (param.type === 'array') {
                    inputHTML = `
                        <textarea id="param-${param.name}" name="param-${param.name}"
                                  placeholder="Enter comma-separated values" ${required}>${param.default_value ? param.default_value.join(', ') : ''}</textarea>
                    `;
                } else {
                    inputHTML = `
                        <input type="text" id="param-${param.name}" name="param-${param.name}"
                               placeholder="${escapeHtml(param.description)}"
                               value="${param.default_value || ''}" ${required}>
                    `;
                }

                formGroup.innerHTML = `
                    <label for="param-${param.name}">${escapeHtml(param.name)} ${requiredMark}</label>
                    ${inputHTML}
                    <div class="form-help">${escapeHtml(param.description)}</div>
                `;

                container.appendChild(formGroup);
            });
        }

        // View template details
        window.viewTemplateDetails = function(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;

            alert(`Template: ${template.name}\n\n${template.description}\n\nRequired Roles: ${template.required_roles.join(', ')}\n\nSteps: ${template.steps.length}`);
        };

        // Handle form submission
        document.getElementById('instantiate-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const templateId = formData.get('template_id');
            const agentName = formData.get('agent_name');

            // Collect parameters
            const parameters = {};
            if (currentTemplate.parameters) {
                currentTemplate.parameters.forEach(param => {
                    const value = formData.get(`param-${param.name}`);
                    if (value) {
                        if (param.type === 'boolean') {
                            parameters[param.name] = value === 'true';
                        } else if (param.type === 'array') {
                            parameters[param.name] = value.split(',').map(v => v.trim());
                        } else {
                            parameters[param.name] = value;
                        }
                    }
                });
            }

            try {
                const response = await fetch('/api/orchestration/templates/instantiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template_id: templateId,
                        agent_name: agentName,
                        parameters: parameters
                    })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                const result = await response.json();

                // Close modal
                window.closeInstantiateModal();

                // Show execution status
                displayExecutionStatus(result);

            } catch (error) {
                console.error('Error executing workflow:', error);
                alert(`Failed to execute workflow: ${error.message}`);
            }
        });

        // Display execution status
        function displayExecutionStatus(result) {
            const statusContainer = document.getElementById('execution-status');
            const workflowContainer = document.getElementById('workflow-status-container');
            const workspaceLink = document.getElementById('workspace-link');

            statusContainer.classList.remove('hidden');

            if (result.result && result.result.workspace_id) {
                currentWorkspaceId = result.result.workspace_id;
                workspaceLink.style.display = 'block';
                workspaceLink.href = `/workspaces?id=${currentWorkspaceId}`;

                // Start monitoring workflow
                workspaceManager.startMonitoringSSE(currentWorkspaceId, (status) => {
                    workspaceManager.renderWorkflowStatus(workflowContainer, status);
                });
            } else {
                workflowContainer.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Workflow Started!</strong>
                        <p>${escapeHtml(result.result.final_output)}</p>
                    </div>
                `;
            }
        }

        // Helper: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize page
        loadTemplates();
    </script>
</body>
</html>
