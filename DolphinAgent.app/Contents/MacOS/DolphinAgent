#!/bin/bash

# Get the directory where the app is located
APP_DIR="$(cd "$(dirname "$0")/../.." && pwd)"
RESOURCES_DIR="$APP_DIR/Resources"

cd "$RESOURCES_DIR"

# Debug: log the paths
echo "APP_DIR: $APP_DIR" > /tmp/dolphin-debug.log
echo "RESOURCES_DIR: $RESOURCES_DIR" >> /tmp/dolphin-debug.log
echo "PWD: $(pwd)" >> /tmp/dolphin-debug.log
echo "ori-agent exists: $(test -f ./ori-agent && echo YES || echo NO)" >> /tmp/dolphin-debug.log

# Start the server
if [ ! -f "./ori-agent" ]; then
    osascript -e 'display dialog "Dolphin Agent server not found. Check /tmp/dolphin-debug.log for details." buttons {"OK"} default button 1 with icon stop'
    exit 1
fi

# Check if already running
if lsof -Pi :8080 -sTCP:LISTEN -t >/dev/null 2>&1 ; then
    osascript -e 'display dialog "Dolphin Agent is already running on port 8080" buttons {"OK"} default button 1 with icon note'
    open http://localhost:8080
    exit 0
fi

# Start server in background
./ori-agent > /tmp/dolphin-agent.log 2>&1 &
SERVER_PID=$!

# Wait for server to start
sleep 2

# Check if server started
if ! kill -0 $SERVER_PID 2>/dev/null; then
    osascript -e 'display dialog "Failed to start Dolphin Agent. Check logs at /tmp/dolphin-agent.log" buttons {"OK"} default button 1 with icon stop'
    exit 1
fi

# Open browser
sleep 1
open http://localhost:8080

# Show success message
osascript -e 'display notification "Server running on port 8080" with title "Dolphin Agent Started"'
